#!/bin/bash

RCFILE="$(pwd)/.fxtbenvrc"
echo $RCFILE
FALLBACK=0

run___PRODUCT__ () {
    command=$1
    profver=$2
    if [ ! -x "$command" ]; then
	echo "No such __PRODUCT__: $command"
	echo "Install __PRODUCT__ $version by 'fxtbenv install __PRODUCT__ $version'"
    else
	echo "$command -no-remote -profile $profver"
	if [ ! -d "$profver" ]; then
	    echo "Creating profile directory: $profver"
	    mkdir -p $profver
	fi
	$command -no-remote -profile $profver
    fi
}

if [ -f "$RCFILE" ]; then
    line=$(\grep __PRODUCT__ $RCFILE)
    product=$(echo $line | cut -d'-' -f1)
    if [ "$product" = "__PRODUCT__" ]; then
	profile=$(echo $line | cut -d'-' -f2)
	version=$(echo $profile | cut -d'@' -f1)
	command=$FXTBENV_HOME/__PRODUCT__/versions/$version/__PRODUCT__
	profver=$FXTBENV_HOME/__PRODUCT__/profiles/$profile
	run___PRODUCT__ $command $profver
    else
	echo "Failed to parse configuration file: $RCFILE:"
    fi
else
    profile=$FXTBENV___CPRODUCT___PROFILE
    if [ -n "$profile" ]; then
	verloc=$(echo $profile | cut -d'@' -f1)
	version=$(echo $verloc | cut -d':' -f1)
	locale=$(echo $verloc | cut -d':' -f2)
	command=$FXTBENV_HOME/__PRODUCT__/versions/$version/$locale/__PRODUCT__
	profdir=$FXTBENV_HOME/__PRODUCT__/profiles/$profile
	run___PRODUCT__ $command $profdir
    else
	FALLBACK=1
    fi
fi
echo $*
if [ $FALLBACK -eq 1 ]; then
    for command in /usr/local/bin/__PRODUCT__ /usr/bin/__PRODUCT__; do
	if [ -x "$command" ]; then
	    echo "Fallback to $command"
	    $command -P $*
	fi
    done
fi
